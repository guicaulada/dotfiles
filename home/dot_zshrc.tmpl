# Antidote plugin manager
source "$HOMEBREW_PREFIX/opt/antidote/share/antidote/antidote.zsh"
antidote load

# zoxide (smarter cd)
_evalcache zoxide init zsh

# atuin (shell history)
_evalcache atuin init zsh

# navi (interactive cheatsheets — Ctrl+G)
_evalcache navi widget zsh

# direnv (per-directory environments — before Starship so env is correct)
_evalcache direnv hook zsh

# Starship (prompt — must init before mise so precmd hooks don't conflict)
eval "$(starship init zsh)"

# mise (runtime version manager — after Starship so _mise_hook isn't overwritten)
eval "$(mise activate zsh)"

# thefuck (lazy-loaded for faster startup)
fuck() {
  unfunction fuck
  eval "$(thefuck --alias)"
  fuck "$@"
}

# Autosuggestions tuning
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
ZSH_AUTOSUGGEST_MANUAL_REBIND=1
ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# History
HISTFILE=~/.zsh_history
HISTSIZE=1000000
SAVEHIST=1000000
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_SPACE
setopt SHARE_HISTORY
setopt HIST_REDUCE_BLANKS

# Completion caching
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path ~/.cache/zsh/completion

# Shell options
setopt AUTO_CD
setopt NO_CLOBBER
setopt EXTENDED_GLOB

# Use emacs key bindings for shell line editing
# Prevents EDITOR={{ .editor }} from enabling vi mode
bindkey -e

# magic-enter (smart empty Enter)
MAGIC_ENTER_GIT_COMMAND='gst'
MAGIC_ENTER_OTHER_COMMAND='ls'

# Aliases
alias vim=nvim
alias cat='bat --paging=never'
alias ls='eza --icons'
alias ll='eza -la --icons --git'
alias lt='eza --tree --icons --level=2'
alias rm='trash'
alias top='btop'
alias cheatsh='navi --print --cheatsh'

# Ghostty tab title (skip inside tmux — tmux owns titles via set-titles)
# Patches Ghostty's internal precmd/preexec hooks (_ghostty_precmd, _ghostty_preexec)
# to append directory-based title updates. Coupled to Ghostty's hook naming convention;
# if Ghostty changes these function names in a future version, this will silently break.
if [[ -z "$TMUX" ]]; then
  _ghostty_title_hook() {
    if (( $+functions[_ghostty_precmd] )); then
      functions[_ghostty_precmd]+='
        builtin print -Pn "\e]0;%1~\a"'
      functions[_ghostty_preexec]+='
        builtin print -Pn "\e]0;%1~\a"'
      print -Pn "\e]0;%1~\a"
      add-zsh-hook -d precmd _ghostty_title_hook
    fi
  }
  autoload -Uz add-zsh-hook
  add-zsh-hook precmd _ghostty_title_hook
fi
